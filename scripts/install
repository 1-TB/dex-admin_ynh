#!/bin/bash

#=================================================
# IMPORT GENERIC HELPERS
#=================================================

source _common.sh
source /usr/share/yunohost/helpers

#=================================================
# CHECK DEX IS INSTALLED
#=================================================
ynh_script_progression "Checking Dex installation..."

if ! yunohost app list --output-as json | grep -q '"id": "dex"'; then
    ynh_die "Error: Dex is not installed. Please install Dex first before installing Dex WebUI Manager."
fi

#=================================================
# INSTALL NODEJS
#=================================================
ynh_script_progression "Installing Node.js..."

# Download and extract Node.js
ynh_setup_source --dest_dir="$install_dir/node" --source_id="main"

# Set permissions
chown -R "$app:$app" "$install_dir/node"

#=================================================
# COPY SOURCE FILES
#=================================================
ynh_script_progression "Setting up source files..."

# Copy backend files
cp -r ../sources/backend "$install_dir/"
chown -R "$app:$app" "$install_dir/backend"

# Copy frontend files
cp -r ../sources/frontend "$install_dir/"
chown -R "$app:$app" "$install_dir/frontend"

#=================================================
# INSTALL BACKEND DEPENDENCIES
#=================================================
ynh_script_progression "Installing backend dependencies..."

pushd "$install_dir/backend"
    ynh_exec_as_app "$install_dir/node/bin/npm" install --production
popd

#=================================================
# BUILD FRONTEND
#=================================================
ynh_script_progression "Building frontend..."

pushd "$install_dir/frontend"
    ynh_exec_as_app "$install_dir/node/bin/npm" install
    ynh_exec_as_app "$install_dir/node/bin/npm" run build
popd

#=================================================
# GRANT SUDO PERMISSIONS FOR DEX OPERATIONS
#=================================================
ynh_script_progression "Configuring sudo permissions..."

# Allow the app to read Dex config directory
usermod -a -G dex "$app" || true

# Create sudoers file to allow systemctl restart dex
cat > "/etc/sudoers.d/${app}" << EOF
${app} ALL=(ALL:ALL) NOPASSWD: /bin/systemctl restart dex
EOF

chmod 440 "/etc/sudoers.d/${app}"

#=================================================
# SYSTEM CONFIGURATION
#=================================================
ynh_script_progression "Adding system configurations..."

# Create a dedicated NGINX config
ynh_config_add_nginx

# Create a dedicated systemd config
ynh_config_add_systemd

# Use logrotate to manage application logfile(s)
ynh_config_add_logrotate

# Integrate service in YunoHost
yunohost service add "$app" --description="Dex WebUI Manager" --log="/var/log/$app/$app.log"

#=================================================
# START SYSTEMD SERVICE
#=================================================
ynh_script_progression "Starting $app's systemd service..."

# Start the service
ynh_systemctl --service="$app" --action="start" --log_path="/var/log/$app/$app.log"

#=================================================
# END OF SCRIPT
#=================================================

ynh_script_progression "Installation of $app completed"
